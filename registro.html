<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Registrar Local</title>
  <style>
    :root{--border:#e5e7eb;--muted:#6b7280;--brand:#0ea5e9;--accent:#f59e0b}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,sans-serif;background:#f8fafc;color:#0b1220;margin:0}
    .wrap{max-width:860px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;margin:0 0 12px;z-index:5}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
    label{display:block;font-weight:600;margin-top:10px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:12px;font:inherit}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:12px;align-items:center;margin-top:16px}
    button{border:0;border-radius:12px;padding:12px 16px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    .muted{color:var(--muted);font-size:.9rem}
    .ok{color:#16a34a}.err{color:#dc2626}
    .zone-row{display:grid;grid-template-columns:2fr 1fr auto;gap:8px;margin:6px 0}
    .pill{display:inline-flex;gap:8px;flex-wrap:wrap}
    .pill label{font-weight:500}
    .pill input[type=checkbox]{transform:translateY(2px)}
    .hr{height:1px;background:#eef2f7;margin:12px 0}
  </style>
</head>
<body>
<header><strong>Alta de Local</strong></header>
<div class="wrap">
  <form id="altaForm" class="card">
    <div class="grid">
      <div>
        <label>Nombre comercial*</label>
        <input name="nombre" required maxlength="80"/>
      </div>
      <div>
        <label>Categoría*</label>
        <select name="categoria" required>
          <option value="">Elegí…</option>
          <option>Rotisería</option>
          <option>Librería</option>
          <option>Kiosco</option>
          <option>Verdulería</option>
          <option>Panadería</option>
          <option>Bebidas</option>
          <option>Electrónica</option>
          <option>Otro</option>
        </select>
      </div>
    </div>

    <label>Descripción (máx. 400)</label>
    <textarea name="descripcion" maxlength="400" rows="3" placeholder="Breve bio del local"></textarea>

    <div class="grid">
      <div>
        <label>WhatsApp de pedidos* (con +54)</label>
        <input name="whatsapp" required placeholder="+5493416XXXXXX" />
      </div>
      <div>
        <label>Estado</label>
        <select name="estado">
          <option value="abierto">Abierto</option>
          <option value="cerrado">Cerrado</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Dirección*</label>
        <input name="direccion" required placeholder="Calle 123, Ciudad" />
      </div>
      <div>
        <label>URL de mapa (opcional)</label>
        <input name="map_url" placeholder="https://maps.google.com/?q=…" />
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Logo (URL)</label>
        <input name="logo" placeholder="https://…/logo.png" />
      </div>
      <div>
        <label>Banner (URL)</label>
        <input name="banner" placeholder="https://…/banner.jpg" />
      </div>
    </div>

    <label>Horarios</label>
    <input name="horarios" placeholder="Lun a Dom 11:30–15:00 y 19:30–23:30" />

    <div class="hr"></div>
    <label>Métodos de entrega*</label>
    <div class="pill">
      <label><input type="checkbox" name="metodo_retiro" checked> Retiro</label>
      <label><input type="checkbox" name="metodo_envio"> Envío</label>
    </div>

    <p class="muted">Modelo elegido: <strong>por barrio/zona</strong>. Podés cargar algunas ahora o editarlas luego desde el panel.</p>
    <div id="zonas"></div>
    <button type="button" id="addZona">+ Agregar zona</button>

    <div class="hr"></div>
    <label>Métodos de pago*</label>
    <div class="pill">
      <label><input type="checkbox" name="pago" value="efectivo" checked> Efectivo</label>
      <label><input type="checkbox" name="pago" value="transferencia" checked> Transferencia</label>
      <label><input type="checkbox" name="pago" value="mercadopago"> Mercado Pago</label>
      <label><input type="checkbox" name="pago" value="debito"> Débito</label>
      <label><input type="checkbox" name="pago" value="credito"> Crédito</label>
    </div>

    <div class="hr"></div>
    <label>Redes (opcionales)</label>
    <div class="grid">
      <input name="instagram" placeholder="https://instagram.com/…"/>
      <input name="facebook" placeholder="https://facebook.com/…"/>
    </div>
    <label>Sitio web (opcional)</label>
    <input name="web" placeholder="https://tusitio.com"/>

    <div class="actions">
      <button type="submit">Enviar solicitud</button>
      <span id="msg" class="muted">Se creará un Pull Request para revisión.</span>
    </div>

    <input type="hidden" id="hcaptcha-token" name="h-captcha-response"/>
  </form>
</div>

<script>
const zonasDiv = document.getElementById('zonas');
document.getElementById('addZona').addEventListener('click', () => addZonaRow());
function addZonaRow(z='', c=''){
  const row = document.createElement('div');
  row.className = 'zone-row';
  row.innerHTML = \`
    <input placeholder="Barrio / Zona" value="\${z}"/>
    <input type="number" min="0" step="100" placeholder="Costo" value="\${c}"/>
    <button type="button">Quitar</button>
  \`;
  row.querySelector('button').onclick = () => row.remove();
  zonasDiv.appendChild(row);
}
addZonaRow('Centro', 1200);

function slugify(s){
  return s.toLowerCase().trim()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
}

document.getElementById('altaForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const msg = document.getElementById('msg');
  msg.className = 'muted'; msg.textContent = 'Enviando…';

  const fd = new FormData(e.target);
  const nombre = fd.get('nombre')?.trim();
  const categoria = fd.get('categoria');
  const whatsapp = fd.get('whatsapp')?.trim();
  const direccion = fd.get('direccion')?.trim();

  if(!nombre || !categoria || !whatsapp || !direccion){
    msg.className = 'err'; msg.textContent = 'Completá los campos obligatorios.'; return;
  }
  if(!/^\+?\d{10,15}$/.test(whatsapp)){
    msg.className = 'err'; msg.textContent = 'WhatsApp inválido. Usá +549…'; return;
  }

  const slug = slugify(nombre);
  const metodos = [];
  if(fd.get('metodo_retiro')) metodos.push('retiro');
  if(fd.get('metodo_envio')) metodos.push('envio');
  if(metodos.length===0){ msg.className='err'; msg.textContent='Elegí al menos un método de entrega.'; return; }

  const pagos = Array.from(document.querySelectorAll('input[name=pago]:checked')).map(x=>x.value);
  if(pagos.length===0){ msg.className='err'; msg.textContent='Elegí al menos un método de pago.'; return; }

  const zonas = Array.from(document.querySelectorAll('.zone-row')).map(r=>{
    const [z,c] = r.querySelectorAll('input');
    return { zona: z.value.trim(), costo: Number(c.value||0) };
  }).filter(z=>z.zona);

  const body = {
    slug,
    nombre,
    categoria,
    descripcion: fd.get('descripcion')?.trim()||'',
    imagenes: {
      logo: fd.get('logo')?.trim()||'',
      banner: fd.get('banner')?.trim()||''
    },
    contacto: {
      whatsapp,
      instagram: fd.get('instagram')?.trim()||'',
      facebook: fd.get('facebook')?.trim()||'',
      web: fd.get('web')?.trim()||''
    },
    direccion: {
      texto: direccion,
      map_url: fd.get('map_url')?.trim()||''
    },
    horarios: fd.get('horarios')?.trim()||'',
    entrega: {
      metodos,
      zonas
    },
    pago: pagos,
    estado: fd.get('estado') || 'abierto',
    orden: 100, // default, editable por admin
  };

  try{
    const res = await fetch('/.netlify/functions/create-local', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ local: body, hcaptcha: document.getElementById('hcaptcha-token').value })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'Error');
    msg.className = 'ok';
    msg.innerHTML = '¡Enviado! Revisaremos tu solicitud. PR: <a href="'+data.pr_url+'" target="_blank">abrir</a>';
  }catch(err){
    msg.className = 'err'; msg.textContent = 'No se pudo enviar: '+err.message;
  }
});
</script>
</body>
</html>
