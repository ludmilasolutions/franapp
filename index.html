<!DOCTYPE html>
<html lang="es-AR" class="no-js">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FranApp · Pedidos locales</title>
  <meta name="description" content="FranApp – Descubrí locales por categoría, filtrá por métodos de entrega y pago, y hacé tu pedido."/>
  <link rel="icon" href="/assets/logo.png" />
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --text:#0b1220; --muted:#6b7280; --border:#e5e7eb;
      --brand:#0ea5e9; --brand-2:#0369a1; --accent:#f59e0b; --ok:#16a34a; --warn:#f97316;
    }
    @media(prefers-color-scheme:dark){
      :root{ --bg:#0b1220; --card:#0f172a; --text:#e6edf3; --muted:#94a3b8; --border:#1e293b; --brand:#38bdf8; --brand-2:#0891b2; --accent:#fbbf24; }
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,sans-serif; background:var(--bg); color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);z-index:10}
    .hbar{display:flex;align-items:center;gap:12px;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .brand .dot{width:10px;height:10px;background:var(--accent);border-radius:50%}
    .sp{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}

    /* Hero */
    .hero{display:grid;grid-template-columns:1.6fr 1fr;gap:18px;align-items:center;padding:18px 16px}
    .hero h1{font-size:clamp(22px,3.6vw,40px);margin:0}
    .hero p{color:var(--muted);margin:.4rem 0 1rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}

    /* Toolbar */
    .toolbar{display:grid;grid-template-columns:1.1fr .6fr .6fr .6fr;gap:10px;margin:10px 0}
    .input{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .input input,.input select{border:0;outline:0;background:transparent;width:100%;color:var(--text)}
    .tog{display:flex;gap:8px;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 10px;border-radius:999px;background:var(--card);cursor:pointer;user-select:none}
    .chip[data-active="1"]{border-color:var(--brand);box-shadow:0 0 0 2px color-mix(in oklab, var(--brand) 25%, transparent)}
    .muted{color:var(--muted)}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px;margin:12px 0 40px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
    .local{position:relative;overflow:hidden;border:1px solid var(--border);border-radius:16px;background:var(--card);transition:transform .12s ease, box-shadow .12s ease}
    .local:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.06)}
    .banner{height:140px;background:#e2e8f0;display:block}
    .banner img{width:100%;height:100%;object-fit:cover;display:block}
    .pad{padding:12px}
    .row{display:flex;align-items:center;gap:12px}
    .logo{width:54px;height:54px;border-radius:14px;overflow:hidden;border:2px solid var(--card);background:#e2e8f0;flex:0 0 54px}
    .logo img{width:100%;height:100%;object-fit:cover}
    .name{font-weight:800;line-height:1.1}
    .cat{font-size:.9rem;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:.78rem;padding:6px 8px;border-radius:999px;border:1px solid var(--border)}
    .pill.ok{background:color-mix(in oklab, var(--ok) 16%, transparent);border-color:color-mix(in oklab, var(--ok) 40%, transparent)}
    .pill.warn{background:color-mix(in oklab, var(--warn) 16%, transparent);border-color:color-mix(in oklab, var(--warn) 40%, transparent)}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .footer{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
    .link{font-weight:700;color:var(--brand)}

    .empty{padding:28px;text-align:center;border:1px dashed var(--border);border-radius:14px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="hbar wrap">
    <div class="brand"><span class="dot"></span><span>FranApp</span></div>
    <div class="sp"></div>
    <a class="btn ghost" href="/registro.html" title="Registrar tu local">Registrar local</a>
  </div>
</header>

<main class="wrap">
  <!-- Hero -->
  <section class="hero">
    <div>
      <h1>Descubrí locales cerca tuyo y pedí en un toque</h1>
      <p>Buscá por nombre o categoría, filtrá por métodos de entrega y pago. Los destacados aparecen primero, después por orden de curación.</p>
      <div class="toolbar">
        <label class="input" title="Buscar">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/></svg>
          <input id="q" placeholder="Buscar por nombre o descripción…" />
        </label>
        <label class="input" title="Categoría">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M6 12h12M9 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <select id="cat">
            <option value="">Todas las categorías</option>
          </select>
        </label>
        <label class="input" title="Orden">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 7h10M7 12h6M7 17h3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <select id="sort">
            <option value="destacado">Destacados primero</option>
            <option value="orden">Curación (orden ascendente)</option>
            <option value="alf">Alfabético (A–Z)</option>
          </select>
        </label>
        <div class="tog">
          <button id="f-open" class="chip" type="button" data-active="0" title="Abiertos ahora">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            Abiertos
          </button>
        </div>
      </div>

      <div class="toolbar" style="grid-template-columns:repeat(3,1fr)">
        <div class="tog">
          <span class="muted" style="min-width:96px">Entrega:</span>
          <button class="chip" type="button" data-filter-entrega="retiro">Retiro</button>
          <button class="chip" type="button" data-filter-entrega="envio">Envío</button>
        </div>
        <div class="tog">
          <span class="muted" style="min-width:96px">Pago:</span>
          <button class="chip" type="button" data-filter-pago="efectivo">Efectivo</button>
          <button class="chip" type="button" data-filter-pago="transferencia">Transferencia</button>
          <button class="chip" type="button" data-filter-pago="mercadopago">MP</button>
          <button class="chip" type="button" data-filter-pago="debito">Débito</button>
          <button class="chip" type="button" data-filter-pago="credito">Crédito</button>
        </div>
        <div class="tog">
          <span id="count" class="muted">—</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:4px 0 10px">¿Tenés un local?</h3>
      <p class="muted" style="margin:0 0 10px">Registralo gratis. Revisamos los datos y lo publicamos.</p>
      <a class="btn" href="/registro.html">Registrar mi local</a>
      <p class="muted" style="margin:10px 0 0;font-size:.9rem">Al enviar, se crea un Pull Request con tu ficha para revisión.</p>
    </div>
  </section>

  <!-- Grid de locales -->
  <section id="list" class="grid" aria-live="polite"></section>
  <div id="empty" class="empty" style="display:none">No encontramos locales con esos filtros.</div>
</main>

<script>
const STATE = {
  locales: [],
  filtered: [],
  cats: new Set(),
  filters: { q:"", cat:"", abiertos:false, entrega:new Set(), pago:new Set(), sort:"destacado" }
};

// Cargar índice de locales (archivo: /data/locales/index.json => ["slug1","slug2",...])
init();
async function init(){
  const listEl = document.getElementById('list');
  listEl.innerHTML = "";
  const idx = await fetchJSON('/data/locales/index.json').catch(()=>null);
  if(!idx || !Array.isArray(idx) || !idx.length){
    listEl.innerHTML = `<div class="empty">Aún no hay locales publicados. <a class="link" href="/registro.html">Registrá el tuyo</a>.</div>`;
    return;
  }
  const all = [];
  for(const slug of idx){
    const item = await fetchJSON(`/data/locales/${slug}.json`).catch(()=>null);
    if(item){ all.push(item); }
  }
  STATE.locales = normalize(all);
  buildCats();
  attachUI();
  applyFilters();
}

function normalize(arr){
  return arr.map(x=>({
    slug: x.slug,
    nombre: x.nombre,
    categoria: x.categoria,
    descripcion: x.descripcion||"",
    imagenes: x.imagenes||{},
    contacto: x.contacto||{},
    direccion: x.direccion||{},
    horarios: x.horarios||"",
    entrega: x.entrega||{metodos:[],zonas:[]},
    pago: Array.isArray(x.pago)? x.pago:[],
    estado: x.estado||'cerrado',
    orden: typeof x.orden==="number"? x.orden: 999,
    destacado: !!x.destacado
  }));
}

async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

function buildCats(){
  STATE.cats = new Set(STATE.locales.map(x=>x.categoria).filter(Boolean));
  const sel = document.getElementById('cat');
  for(const c of [...STATE.cats].sort()){
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c; sel.appendChild(opt);
  }
}

function attachUI(){
  document.getElementById('q').addEventListener('input', e=>{ STATE.filters.q = e.target.value.toLowerCase().trim(); applyFilters(); });
  document.getElementById('cat').addEventListener('change', e=>{ STATE.filters.cat = e.target.value; applyFilters(); });
  document.getElementById('sort').addEventListener('change', e=>{ STATE.filters.sort = e.target.value; applyFilters(); });
  const openBtn = document.getElementById('f-open');
  openBtn.addEventListener('click', ()=>{ const v = openBtn.getAttribute('data-active')==='1'; openBtn.setAttribute('data-active', v? '0':'1'); STATE.filters.abiertos = !v; applyFilters(); });
  document.querySelectorAll('[data-filter-entrega]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      toggleChip(btn);
      const k = btn.getAttribute('data-filter-entrega');
      if(STATE.filters.entrega.has(k)) STATE.filters.entrega.delete(k); else STATE.filters.entrega.add(k);
      applyFilters();
    });
  });
  document.querySelectorAll('[data-filter-pago]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      toggleChip(btn);
      const k = btn.getAttribute('data-filter-pago');
      if(STATE.filters.pago.has(k)) STATE.filters.pago.delete(k); else STATE.filters.pago.add(k);
      applyFilters();
    });
  });
}
function toggleChip(el){ el.dataset.active = el.dataset.active==='1' ? '0':'1'; }

function applyFilters(){
  const f = STATE.filters;
  let arr = [...STATE.locales];

  if(f.q){ const q=f.q; arr = arr.filter(x=>`${x.nombre} ${x.descripcion} ${x.categoria}`.toLowerCase().includes(q)); }
  if(f.cat){ arr = arr.filter(x=>x.categoria===f.cat); }
  if(f.abiertos){ arr = arr.filter(x=>x.estado==='abierto'); }
  if(f.entrega.size){ arr = arr.filter(x=> x.entrega && x.entrega.metodos && x.entrega.metodos.some(m=>f.entrega.has(m))); }
  if(f.pago.size){ arr = arr.filter(x=> x.pago && x.pago.some(p=>f.pago.has(p))); }

  // Orden
  if(f.sort==='destacado'){
    arr.sort((a,b)=> (b.destacado - a.destacado) || (a.orden - b.orden) || a.nombre.localeCompare(b.nombre) );
  }else if(f.sort==='orden'){
    arr.sort((a,b)=> (a.orden - b.orden) || a.nombre.localeCompare(b.nombre));
  }else{
    arr.sort((a,b)=> a.nombre.localeCompare(b.nombre));
  }

  STATE.filtered = arr;
  document.getElementById('count').textContent = `${arr.length} local(es)`;
  renderList(arr);
}

function renderList(arr){
  const list = document.getElementById('list');
  const empty = document.getElementById('empty');
  list.innerHTML = '';
  if(!arr.length){ empty.style.display='block'; return; } else { empty.style.display='none'; }
  for(const x of arr){ list.appendChild(card(x)); }
}

function card(x){
  const el = document.createElement('article'); el.className='local';
  // Banner
  const bn = document.createElement('a'); bn.className='banner'; bn.href = `/local.html?slug=${encodeURIComponent(x.slug)}`;
  bn.innerHTML = x.imagenes?.banner ? `<img src="${escapeHtml(x.imagenes.banner)}" alt="Banner ${escapeHtml(x.nombre)}" loading="lazy">` : '';
  el.appendChild(bn);
  // Body
  const pad = document.createElement('div'); pad.className='pad';
  const head = document.createElement('div'); head.className='row';
  head.innerHTML = `
    <div class="logo">${ x.imagenes?.logo ? `<img src="${escapeHtml(x.imagenes.logo)}" alt="Logo ${escapeHtml(x.nombre)}" loading="lazy">` : ''}</div>
    <div style="min-width:0">
      <div class="name">${escapeHtml(x.nombre)}</div>
      <div class="cat">${escapeHtml(x.categoria||'')}</div>
    </div>
    <div class="sp"></div>
    <span class="pill ${x.estado==='abierto'?'ok':'warn'}" title="Estado">${x.estado==='abierto'?'Abierto':'Cerrado'}</span>
  `;
  pad.appendChild(head);

  const meta = document.createElement('div'); meta.className='meta';
  // Entrega
  if(x.entrega?.metodos?.length){
    meta.appendChild(pill(iconTruck(),'Entrega: '+ x.entrega.metodos.map(m=>m==='envio'?'Envío':'Retiro').join(' / ')));
  }
  // Pago
  if(x.pago?.length){ meta.appendChild(pill(iconCard(),'Pago: '+ x.pago.map(mapPago).join(', '))); }
  // Destacado / Orden
  if(x.destacado){ meta.appendChild(pill(star(),'Destacado')); }
  meta.appendChild(pill(sortIco(),'Orden '+ (x.orden??'-')));
  pad.appendChild(meta);

  const foot = document.createElement('div'); foot.className='footer';
  const addr = (x.direccion?.texto||'').trim();
  foot.innerHTML = `
    <a class="link" href="/local.html?slug=${encodeURIComponent(x.slug)}">Ver local</a>
    <a class="btn" href="${waLink(x)}" target="_blank" rel="noopener">WhatsApp</a>
  `;
  pad.appendChild(foot);

  el.appendChild(pad);
  return el;
}

function pill(svg, text){
  const span = document.createElement('span'); span.className='pill';
  span.appendChild(svg); const t=document.createElement('span'); t.textContent=text; span.appendChild(t);
  return span;
}

function waLink(x){
  const num = (x.contacto?.whatsapp||'').replace(/[^\d]/g,'');
  const msg = encodeURIComponent(`Hola ${x.nombre}, vengo de FranApp.`);
  return num? `https://wa.me/${num}?text=${msg}` : '#';
}

function mapPago(k){
  return ({efectivo:'Efectivo', transferencia:'Transferencia', mercadopago:'MP', debito:'Débito', credito:'Crédito'})[k]||k;
}

function iconTruck(){ const s=document.createElementNS('http://www.w3.org/2000/svg','svg'); s.setAttribute('width','14'); s.setAttribute('height','14'); s.setAttribute('viewBox','0 0 24 24'); s.innerHTML='<path d="M3 7h11v6h-1.5a2.5 2.5 0 1 0 0 5H14a2.5 2.5 0 1 0 5 0h2v-6l-3-5h-4V7H3z" fill="currentColor"/>'; return s; }
function iconCard(){ const s=document.createElementNS('http://www.w3.org/2000/svg','svg'); s.setAttribute('width','14'); s.setAttribute('height','14'); s.setAttribute('viewBox','0 0 24 24'); s.innerHTML='<rect x="2" y="5" width="20" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><path d="M2 10h20" stroke="currentColor" stroke-width="2"/>'; return s; }
function star(){ const s=document.createElementNS('http://www.w3.org/2000/svg','svg'); s.setAttribute('width','14'); s.setAttribute('height','14'); s.setAttribute('viewBox','0 0 24 24'); s.innerHTML='<path d="m12 3 2.6 5.3 5.8.8-4.2 4.1 1 5.8L12 16.9 6.8 19l1-5.8L3.6 9.1l5.8-.8L12 3z" fill="currentColor"/>'; return s; }
function sortIco(){ const s=document.createElementNS('http://www.w3.org/2000/svg','svg'); s.setAttribute('width','14'); s.setAttribute('height','14'); s.setAttribute('viewBox','0 0 24 24'); s.innerHTML='<path d="M7 7h10M7 12h6M7 17h3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>'; return s; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",
  ">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
</script>
</body>
</html>
